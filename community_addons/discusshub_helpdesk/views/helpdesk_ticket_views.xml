<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View: Add WhatsApp to Helpdesk Ticket -->
    <record id="view_helpdesk_ticket_form_discusshub" model="ir.ui.view">
        <field name="name">helpdesk.ticket.form.discusshub</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_ticket_view_form"/>
        <field name="arch" type="xml">

            <!-- Smart Button -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_open_discusshub_channel"
                        type="object"
                        class="oe_stat_button"
                        icon="fa-whatsapp"
                        invisible="not discusshub_channel_id">
                    <field name="discusshub_message_count" widget="statinfo" string="WhatsApp"/>
                </button>
            </xpath>

            <!-- WhatsApp Page -->
            <xpath expr="//notebook" position="inside">
                <page string="WhatsApp" name="discusshub">
                    <group>
                        <group>
                            <field name="discusshub_channel_id" readonly="1"/>
                            <field name="discusshub_message_count" readonly="1"/>
                            <field name="discusshub_last_message_date" readonly="1"/>
                        </group>
                        <group>
                            <button name="action_create_discusshub_channel"
                                    string="Create WhatsApp Channel"
                                    type="object"
                                    class="btn-primary"
                                    invisible="discusshub_channel_id"/>
                            <button name="action_send_discusshub_message"
                                    string="Send Message"
                                    type="object"
                                    class="btn-success"
                                    invisible="not discusshub_channel_id"/>
                        </group>
                    </group>
                </page>
            </xpath>

        </field>
    </record>

    <!-- Tree View: WhatsApp Column -->
    <record id="view_helpdesk_ticket_tree_discusshub" model="ir.ui.view">
        <field name="name">helpdesk.ticket.tree.discusshub</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_tickets_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="discusshub_channel_id" string="WhatsApp" widget="boolean_button" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Bulk Send Action for Helpdesk Tickets -->
    <!-- ============================================================ -->

    <record id="action_helpdesk_ticket_bulk_send_whatsapp" model="ir.actions.server">
        <field name="name">Send WhatsApp Template (Bulk)</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="binding_model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
# Get selected record IDs
if records:
    res_ids = ','.join(str(rec.id) for rec in records)

    action = {
        'name': 'Bulk Send WhatsApp Template',
        'type': 'ir.actions.act_window',
        'res_model': 'discuss_hub.bulk_send_wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': {
            'default_res_model': 'helpdesk.ticket',
            'default_res_ids': res_ids,
        },
    }
else:
    raise UserError('Please select at least one ticket.')
        ]]></field>
    </record>

</odoo>
